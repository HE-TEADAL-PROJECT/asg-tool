# ASG-SFDP

**ASG-SFDP** is a FastAPI-based data-serving app, created automatically by the **ASG-tool** and, at runtime, dependent on the **asg-runtime** library.

## Features

ASG-SFDP inherits its features from the **asg-runtime** library and supports the following endpoints:

### Service Endpoints

- `/service/stats`
- `/service/settings`
- `/service/transforms`
- `/service/origin_cache/clean`
- `/service/response_cache/clean`

### Data Endpoints

These are one or more endpoints under the `/data/` path, generated by the ASG-tool according to the FDP-to-SFDP contract specification.

## Configuration

ASG-SFDP can be configured through environment variables.  
Example settings are provided in the [.env file](./.env), which can be modified to adjust the runtime behavior of the SFDP app.

## Installation and Usage

There are several options to install and run the SFDP.

### Install and run locally from git sources
> tested to work on Windows with `gitbash` and on `WSL2` `ubuntu24`
> these instructions assume you have access to the TEADAL GitLab

To run SFDP locally:

1. Clone the repository and enter the cloned directory.
```sh
$ git clone <sfdp-repo-link> <sfdp-project-dir>
$ cd <sfdp-project-dir>
```

1. Create and activate a fresh Python 3.12 virtual environment.
```sh
# make sure you have python 3.12
$ which python
$ python --version

# create virtual environment
$ python -m venv .venv

# activate virtual environment
$ . .venv/Scripts/activate  # if on windows
$ . .venv/bin/activate      # if on lnx
(.venv)                     

# make sure activation worked
$ which python
# should be <your_working_dir>/.venv/Scripts/python
(.venv)
$ which pip
# should be <your_working_dir>/.venv/Scripts/pip
(.venv)
$ pip list
# should list only pip package

# optionally upgrade the pip package to its latest version
$ python -m pip install --upgrade pip
```

1. Install dependencies. ASG-generated apps depend on `fastapi` and `uvicorn` packages and, for most of the common funtionality, on `asg-runtime` package. 

- To install locally, use the [requirements-local.txt](./requirements-local.txt) for pulling `asg-runtime` library sources from the TEADAL Gitlab. Check whether you need to modify repo link, e.g., to accomodate your `gitconfig` or in case the repo was relocated. Note also that for some configuration choices additional packages might have to be installed as explained in [.env file](./.env) file. If these configuration options are selected without installing the required packages, the app will fail to start and report the problem.

```sh
# in regular mode
pip install -r requirements-local.txt

# or, to run in dev mode:
pip install -r requirements-dev.txt

# alternatively you can rely on build tools:
$ pip install .[local]      # for local
$ pip install .[local,dev]  # for dev mode install
```

1. Inspect the settings in the [.env file](./.env) file match your needs, and if needed install additional packages, such as `diskcashe` or `redis`.
```sh
$ pip install .[cache-disk]     # if you require disk cache
$ pip install .[cache-redis]    # if you require redis cache
$ pip install .[logging-rich]   # for nicer formatted logs
```
1. Start the service locally:

```sh
# in regular mode
uvicorn app:app

# in development mode:
fastapi dev
```

### Create local image and run the container 

On a system that supports containerization (e.g., Docker, Podman), you can build and run a local container image:

1. To build image with the latest asg-runtime code, use [Dockerfile_from_src](./Dockerfile_from_src). 
It pulls from a private GitLab repository of the project and thus requires valid `ssh` configuration. 
You can follow instructions below or, if you know what you are doing, you can change the `Dockerfile` and, posibly also the `requirements.txt` to support `http` access with tokens.

- Make sure you have ssh access to TEADAL's GitLab server

```sh
ssh -T git@gitlab.teadal.ubiwhere.com
```

- Add your keys to active ssh agent (so it can be used ducting docker build)

```sh
eval $(ssh-agent)
ssh-keyscan gitlab.teadal.ubiwhere.com
ssh-add ~/.ssh/<key>  # use your actual private key
```

- Now build the image
```sh
DOCKER_BUILDKIT=1 docker build --ssh default -t <asg-sfdp>:local -f Dockerfile_from_src .
```

1. Alternatively, it is possible to build the image from the base `asg-runtime` library image using the [Dockerfile_from_img](./Dockerfile_from_img). Note that you might want to change the image tag used before running the build command as follows:
```sh
docker build  -t <asg-sfdp:local -f Dockerfile_from_img  .
```

- Now run the image while providing it the settings 
```sh
docker run -v $(pwd)/.env:/app/.env -it --rm -p 8000:8000 sfdp-med-img:local

# or 

docker run --env-file .env -it --rm -p 8000:8000 <asg-sfdp>:local

# or as separate variables
```

- Now you should be able to access the image (if running locally) at `http://localhost:8000/docs`


#### Notes 
If you are building inside a VM and encounter network issues, try:

```sh
docker build --network=host -t <asg-sfdp>:local .
```

If this does not help, you might need additional infrastructure troubleshooting. 

Once the image is created (check with `docker images`), you can run the container:

```sh
docker run -it --rm -p 8000:8000 <asg-sfdp>:local
```

Again, if running inside a VM with networking issues, you can run with host networking:

```sh
docker run --rm -it --network=host <asg-sfdp>:local
```
### Deploying on k8s/TEADAL Node
When you have validated the app, push it into a new repo in your pilot's group in the TEADAL Gitlab. This will trigger CI script for building and pushing the image into your pilot's group registry. From there, images can be deployed after adding the reqiuered manifests and policy files in the target k8s cluster / TEADAL Node.

## Accessing the Service

When the SFDP app is running, its endpoints can be accessed either through a web browser to `http://<service IP>/docs` for swagger, or using tools like `curl`. For local installations, the `service IP` will be reported on a terminal, e.g., `127.0.0.1:8000`.

## Directory Structure

```plaintext
|                           # Git files
├── .gitatributes        
├── .gitignore         
|                           # Gitlab files     
├── .gitlab-ci.yml           
|                           # Docker files
├── .dockerignore
├── Dockerfile              # dockerfile used by Gitlab CI (from image)
├── Dockerfile_from_img     # dockerfile to create container from asg-runtime image
├── Dockerfile_from_src     # dockerfile to create container from asg-runtime source
|                           # Requirements files
├── requirements-docker.txt # external dependencies
├── requirements-local.txt  # external plus asg-runtime
├── requirements-dev.txt    # local plus dev tools
|                           # application files     
├── app.py                  # The main FastAPI application
├── .env                    # application settings
├── pyproject.toml          # application build settings
├── transforms/             # transformation functions
├── README.md/              # this file :-)
```

