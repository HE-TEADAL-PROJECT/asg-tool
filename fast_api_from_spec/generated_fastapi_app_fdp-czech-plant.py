from fastapi import FastAPI
import requests
from fastapi.responses import JSONResponse
import pandas as pd
from transform import handle_transform
from acg.executor import exec
from langchain_core.documents.base import Document
from acg.types import ApiCallInf,ApiCallIssues

app = FastAPI()

# Define FastAPI endpoints

@app.get("/year-quarter")
async def shipments_endpoint():
    """
    Returns all the shipments that are present in the sFDP.

    """
    path_params = {
    }
    query_params = {
    }
    # Create Yaml and run executor
    endpoint_data = {'method': 'get', 'path': '/shipments', 'sfdp_endpoint_name': 'shipments_endpoint', 'sfdp_endpoint_path': '/year-quarter', 'name': 'getShipments', 'parameters': [], 'description': 'Returns all the shipments that are present in the sFDP.\n', 'response_model': {'name': 'Shipments', 'properties': {'type': 'array', 'items': {'type': 'object', 'properties': {'year': {'type': 'integer', 'example': 2024}, 'month': {'type': 'integer', 'example': 12}, 'week': {'type': 'integer', 'example': 3}, 'customer_id': {'type': 'number', 'example': 1111}, 'customer_name': {'type': 'string', 'example': 'John Doe'}, 'item_id': {'type': 'string', 'example': 30331568937}, 'item_desc': {'type': 'string', 'example': 'piece of pieces'}}, 'required': ['customer_id', 'item_id']}}}}
    con_spec = handle_transform.create_spec_section(endpoint_data, 'http://localhost:8003/fdp-czech-plant', "1234", "apiToken", path_params, query_params)

    transformations_instructions = [{'endpoint': 'shipments_endpoint', 'context_metadata': [{'description': 'Filters a DataFrame to return rows where the year matches the given input_year.', 'endpoint': 'filter_by_year', 'method': 'GET', 'operation_id': 'filter_by_year', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "The input pandas DataFrame.", "required": true}, "year_col": {"type": "str", "description": "The name of the column containing the year values.", "required": true}, "input_year": {"type": "integer", "description": "The year to filter the DataFrame by.", "required": true}}', 'summary': 'filter_by_year', 'tag': 'tools', 'title': 'filter_by_year', 'similarity_score': 0.5113303036954706, 'relevance_score': 0.660344123840332}, {'description': 'map fields or change names from source to target.', 'endpoint': 'map_field', 'method': 'GET', 'operation_id': 'map_field', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "input dataframe.", "required": true}, "source": {"type": "str", "description": "The first column name.", "required": true}, "target": {"type": "str", "description": "The second column name.", "required": true}}', 'summary': 'map_field', 'tag': 'tools', 'title': 'map_field', 'similarity_score': 0.4086855316572513, 'relevance_score': 0.5670754313468933}, {'description': 'concatenate Two fields.', 'endpoint': 'concatenate_fields', 'method': 'GET', 'operation_id': 'concatenate_fields', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "input dataframe.", "required": true}, "col1": {"type": "str", "description": "The first column.", "required": true}, "col2": {"type": "str", "description": "The second column.", "required": true}, "output": {"type": "str", "description": "the new column name, the target.", "required": true}}', 'summary': 'concatenate_fields', 'tag': 'tools', 'title': 'concatenate_fields', 'similarity_score': 0.29925292537265535, 'relevance_score': 0.5577986836433411}, {'description': 'Filters a DataFrame to return rows where the month falls within the specified quarter.', 'endpoint': 'filter_by_quarter', 'method': 'GET', 'operation_id': 'filter_by_quarter', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "The input pandas DataFrame.", "required": true}, "month_col": {"type": "str", "description": "The name of the column containing the month values.", "required": true}, "quarter": {"type": "integer", "description": "The quarter to filter by (1 for Q1, 2 for Q2, 3 for Q3, 4 for Q4).", "required": true}}', 'summary': 'filter_by_quarter', 'tag': 'tools', 'title': 'filter_by_quarter', 'similarity_score': 0.36999287026291605, 'relevance_score': 0.5139820575714111}], 'api_calls': [ApiCallInf(raw_str=' {"name": "tools.filter_by_year", "arguments": {"df": "input_df", "year_col": "year", "input_year": 2024}}', valid=True, name='tools.filter_by_year', parameters={'df': 'input_df', 'year_col': 'year', 'input_year': 2024}, issues=ApiCallIssues(syntax_error=False, call_hallucinated=False, param_hallucinated=[], param_mistyped=[], param_missing=[], param_missing_info=[], param_outside_bounds=[], blank_substring=0, invalid_pair=[], repeated_arg=[], invalid_value=[]))], 'target_name': 'year', 'output_df_name': 'Shipment'}, {'endpoint': 'shipments_endpoint', 'context_metadata': [{'description': 'Filters a DataFrame to return rows where the month falls within the specified quarter.', 'endpoint': 'filter_by_quarter', 'method': 'GET', 'operation_id': 'filter_by_quarter', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "The input pandas DataFrame.", "required": true}, "month_col": {"type": "str", "description": "The name of the column containing the month values.", "required": true}, "quarter": {"type": "integer", "description": "The quarter to filter by (1 for Q1, 2 for Q2, 3 for Q3, 4 for Q4).", "required": true}}', 'summary': 'filter_by_quarter', 'tag': 'tools', 'title': 'filter_by_quarter', 'similarity_score': 0.6436271959755899, 'relevance_score': 0.6344853043556213}, {'description': 'Filters a DataFrame to return rows where the month falls within the specified quarter.', 'endpoint': 'filter_by_quarter', 'method': 'GET', 'operation_id': 'filter_by_quarter', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "The input pandas DataFrame.", "required": true}, "month_col": {"type": "str", "description": "The name of the column containing the month values.", "required": true}, "quarter": {"type": "integer", "description": "The quarter to filter by (1 for Q1, 2 for Q2, 3 for Q3, 4 for Q4).", "required": true}}', 'summary': 'filter_by_quarter', 'tag': 'tools', 'title': 'filter_by_quarter', 'similarity_score': 0.6436271959755899, 'relevance_score': 0.6344853043556213}, {'description': 'Filters a DataFrame to return rows where the year matches the given input_year.', 'endpoint': 'filter_by_year', 'method': 'GET', 'operation_id': 'filter_by_year', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "The input pandas DataFrame.", "required": true}, "year_col": {"type": "str", "description": "The name of the column containing the year values.", "required": true}, "input_year": {"type": "integer", "description": "The year to filter the DataFrame by.", "required": true}}', 'summary': 'filter_by_year', 'tag': 'tools', 'title': 'filter_by_year', 'similarity_score': 0.39603389067125105, 'relevance_score': 0.4433736503124237}, {'description': 'Filters a DataFrame to return rows where the year matches the given input_year.', 'endpoint': 'filter_by_year', 'method': 'GET', 'operation_id': 'filter_by_year', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "The input pandas DataFrame.", "required": true}, "year_col": {"type": "str", "description": "The name of the column containing the year values.", "required": true}, "input_year": {"type": "integer", "description": "The year to filter the DataFrame by.", "required": true}}', 'summary': 'filter_by_year', 'tag': 'tools', 'title': 'filter_by_year', 'similarity_score': 0.39603389067125105, 'relevance_score': 0.4433736503124237}], 'api_calls': [ApiCallInf(raw_str=' {"name": "tools.filter_by_quarter", "arguments": {"df": "df", "month_col": "month", "quarter": 4}}', valid=True, name='tools.filter_by_quarter', parameters={'df': 'df', 'month_col': 'month', 'quarter': 4}, issues=ApiCallIssues(syntax_error=False, call_hallucinated=False, param_hallucinated=[], param_mistyped=[], param_missing=[], param_missing_info=[], param_outside_bounds=[], blank_substring=0, invalid_pair=[], repeated_arg=[], invalid_value=[]))], 'target_name': 'month', 'output_df_name': 'Shipment'}, {'endpoint': 'shipments_endpoint', 'context_metadata': [{'description': 'concatenate Two fields.', 'endpoint': 'concatenate_fields', 'method': 'GET', 'operation_id': 'concatenate_fields', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "input dataframe.", "required": true}, "col1": {"type": "str", "description": "The first column.", "required": true}, "col2": {"type": "str", "description": "The second column.", "required": true}, "output": {"type": "str", "description": "the new column name, the target.", "required": true}}', 'summary': 'concatenate_fields', 'tag': 'tools', 'title': 'concatenate_fields', 'similarity_score': 0.5191352256901121, 'relevance_score': 0.7177977561950684}, {'description': 'concatenate Two fields.', 'endpoint': 'concatenate_fields', 'method': 'GET', 'operation_id': 'concatenate_fields', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "input dataframe.", "required": true}, "col1": {"type": "str", "description": "The first column.", "required": true}, "col2": {"type": "str", "description": "The second column.", "required": true}, "output": {"type": "str", "description": "the new column name, the target.", "required": true}}', 'summary': 'concatenate_fields', 'tag': 'tools', 'title': 'concatenate_fields', 'similarity_score': 0.5191352256901121, 'relevance_score': 0.7177977561950684}, {'description': 'concatenate Two fields.', 'endpoint': 'concatenate_fields', 'method': 'GET', 'operation_id': 'concatenate_fields', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "input dataframe.", "required": true}, "col1": {"type": "str", "description": "The first column.", "required": true}, "col2": {"type": "str", "description": "The second column.", "required": true}, "output": {"type": "str", "description": "the new column name, the target.", "required": true}}', 'summary': 'concatenate_fields', 'tag': 'tools', 'title': 'concatenate_fields', 'similarity_score': 0.5191352256901121, 'relevance_score': 0.7177977561950684}, {'description': 'map fields or change names from source to target.', 'endpoint': 'map_field', 'method': 'GET', 'operation_id': 'map_field', 'output_schema': '{}', 'parameters': '{"df": {"type": "any", "description": "input dataframe.", "required": true}, "source": {"type": "str", "description": "The first column name.", "required": true}, "target": {"type": "str", "description": "The second column name.", "required": true}}', 'summary': 'map_field', 'tag': 'tools', 'title': 'map_field', 'similarity_score': 0.45546238006446105, 'relevance_score': 0.699184000492096}], 'api_calls': [ApiCallInf(raw_str=' {"name": "tools.concatenate_fields", "arguments": {"df": "df", "col1": "customer_name", "col2": "customer_id", "output": "customer_name_id"}}', valid=True, name='tools.concatenate_fields', parameters={'df': 'df', 'col1': 'customer_name', 'col2': 'customer_id', 'output': 'customer_name_id'}, issues=ApiCallIssues(syntax_error=False, call_hallucinated=False, param_hallucinated=[], param_mistyped=[], param_missing=[], param_missing_info=[], param_outside_bounds=[], blank_substring=0, invalid_pair=[], repeated_arg=[], invalid_value=[]))], 'target_name': 'customer_name_id', 'output_df_name': 'Shipment'}]
    full_spec = handle_transform.add_export_section('shipments_endpoint', con_spec, transformations_instructions)
    res = exec.run_from_spec_string(full_spec)
    try:
        response_data = {key: (df.dropna()).to_dict(orient='records') for key, df in res.items()}
    except:
        # In case no transformations, return json.
        return JSONResponse(res['.'])
    return JSONResponse(response_data)
