from fastapi import FastAPI
import requests
from fastapi.responses import JSONResponse
import pandas as pd
from transform import transform_functions

app = FastAPI()

# Define FastAPI endpoints
{% for endpoint in endpoints %}
@app.{{ endpoint.method }}("{{ endpoint.path }}")
async def {{ endpoint.name }}({% for param in endpoint.parameters %}{{ param.name }}: {% if param.type == 'string' %}str{% elif param.type == 'integer' %}int{% elif param.type == 'boolean' %}bool{% elif param.type == 'number' %}float{% else %}Any{% endif %}{% if param.nullable %} = None{% endif %}{% if not loop.last %}, {% endif %}{% endfor %}):
    """
    {{ endpoint.description }}
    """
    path_params = {
        {%- for param in endpoint.parameters if param.in == 'path' %}
        "{{ param.name }}": {{ param.name }}{%- if not loop.last %},{%- endif %}
        {%- endfor %}
    }
    query_params = {
        {%- for param in endpoint.parameters if param.in == 'query' %}
        "{{ param.name }}": {{ param.name }}{%- if not loop.last %},{%- endif %}
        {%- endfor %}
    }
    response = requests.{{ endpoint.method }}("{{teadal_server}}{{ endpoint.path }}".format(**path_params), params=query_params)
    response_data = response.json()
    # Perform your transformation here
    # Transform to DF.
    # Create DataFrame from the response data
    df = pd.DataFrame(response_data)
    
    # Apply transformation functions
    {% for func in functions %}
    df = transform_functions.{{ func.name }}(df=df, {% for param_name, param_value in func.parameters.items() if param_name != 'df' %}
        {{ param_name }}='{{ param_value }}'{% if not loop.last %}, {% endif %}
        {% endfor %})
    {% endfor %}
    
    # Return the transformed result
    return JSONResponse(df.to_dict(orient="records"))
{% endfor %}
